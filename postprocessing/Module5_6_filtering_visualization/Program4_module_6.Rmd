---
title: "Program 4 - Module 6 Knowledge data analysis and visualization"
date: "2025-08-09"
author: "Martina Lori & Ricardo Leitão"
output:
  html_document: default
  pdata_document: default
---
This document contains the R script for the  **Program 4 - Module 6 Knowledge data analysis and visualization** of the paper "Large Language Models as Rapid Evidence Synthesis Tools in Soil Ecology". To address the targeted literature gaps, selected abstracts were fed to the LLM for structured knowledge extraction using the developed prompt chain (LEPAMTIC_V6). The model-generated "extraction table" was then processed in a Python script to filter, normalize, and produce a "harmonized extraction table", which was subsequently tailored to the two focal gaps—biochar and retaining crop residues versus soil fauna, produce the "final extraction table", and analyzed to yield the final results of this study.

In this script we check the "final extraction table", describe the final results and build the plots for visualization

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages

```{r}
library(stringr)
library(readxl)
library(ggh4x)
library(ggpubr)
library(tidyverse)
```

# Define folder paths
```{r}
# Define the path
folder_path_tables <- "tables"

# Create the directory if it doesn't already exist
if (!dir.exists(folder_path_tables)) {
  dir.create(folder_path_tables)
}

# Define the path
folder_path_plots <- "plots"

# Create the directory if it doesn't already exist
if (!dir.exists(folder_path_plots)) {
  dir.create(folder_path_plots)
}
```
# .........................................................................................................

## Save
```{r}
write.csv(data_practice, "Final_extraction_table.csv", row.names = FALSE, na = "")

#saveRDS(data_practice, "Final_extraction_table.rds")

```

## Split Practices
```{r}
biochar <- data_practice %>%
  filter(Practice == "Biochar") %>%
  mutate(Practice = droplevels(Practice))

retaining_residues <- data_practice %>%
  filter(Practice == "Retaining crop residues") %>%
  mutate(Practice = droplevels(Practice))
```

## Counts
```{r}
# 1) Add DOI_id (numbered by first appearance of each DOI)
biochar2 <- biochar %>%
  mutate(DOI_id = as.integer(factor(DOI, levels = unique(DOI))))

# 2) Build the counts table and list the DOI_ids that contributed to each combo
df_counts_biochar <- biochar2 %>%
  unite("Practice_Effect_Actor_Property_Contrast",
        Practice, Effect, Actor, Property, Contrast,
        sep = "_", na.rm = TRUE) %>%
  group_by(Practice_Effect_Actor_Property_Contrast) %>%
  summarise(
    count   = n(),
    DOI_ids = paste(sort(unique(DOI_id[!is.na(DOI_id)])), collapse = ",")
  , .groups = "drop") %>%
  arrange(desc(count))

# 1) Add DOI_id (numbered by first appearance of each DOI)
retaining_residues2 <- retaining_residues %>%
  mutate(DOI_id = as.integer(factor(DOI, levels = unique(DOI))))

# 2) Build the counts table and list the DOI_ids that contributed to each combo
df_counts_retaining_residues <- retaining_residues2 %>%
  unite("Practice_Effect_Actor_Property_Contrast",
        Practice, Effect, Actor, Property, Contrast,
        sep = "_", na.rm = TRUE) %>%
  group_by(Practice_Effect_Actor_Property_Contrast) %>%
  summarise(
    count   = n(),
    DOI_ids = paste(sort(unique(DOI_id[!is.na(DOI_id)])), collapse = ",")
  , .groups = "drop") %>%
  arrange(desc(count))

nem_pat <- regex("nematode", ignore_case = TRUE)
nem_proto <- regex("protozoa", ignore_case = TRUE)
col_join <- "Practice_Effect_Actor_Property_Contrast"

biochar_nema <- df_counts_biochar %>%
  filter(coalesce(str_detect(.data[[col_join]], nem_pat), FALSE))
biochar_nema

biochar_rest <- df_counts_biochar %>%
  filter(!coalesce(str_detect(.data[[col_join]], nem_pat), FALSE))
biochar_rest

biochar_proto <- df_counts_biochar %>%
  filter(coalesce(str_detect(.data[[col_join]], nem_proto), FALSE))
biochar_proto

residues_nema <- df_counts_retaining_residues %>%
  filter(coalesce(str_detect(.data[[col_join]], nem_pat), FALSE))
residues_nema

residues_rest <- df_counts_retaining_residues %>%
  filter(!coalesce(str_detect(.data[[col_join]], nem_pat), FALSE))
residues_rest

residues_proto <- df_counts_retaining_residues %>%
  filter(coalesce(str_detect(.data[[col_join]], nem_proto), FALSE))
residues_proto
```
# .........................................................................................................

Here, we first inspect the “final extraction table.” We then present and describe the results with summary plots, culminating in the final figures that show the number of extracted patterns distributed by (i) practice × actor and (ii) practice × property

## Load data
```{r}
data_practice <- read_excel("final_extraction_table.csv", sheet = "Sheet1")
```

## Distribution of key elements plot
```{r}
#data <- read_csv("Final_extraction_table_Luis.csv")
levels(data_practice$Actor)
data <- data_practice
num_levels <- data %>%  dplyr::summarise(n_levels = n_distinct(DOI))
data$Actor[data$Actor == "Pest parasitic nematodes"] <- "Plant feeders nematodes"
data$Actor[data$Actor == "Growth promoting protozoa"] <- "Protozoa"

data$Actor <- droplevels(data$Actor)
unique(levels(data$Actor))
data <- data %>%
   dplyr::mutate(Property = recode(Property, "biomass" = "abundance"))
data <- data %>%
  dplyr::mutate(Group = case_when(
    Actor %in% c("Earthworms", "Isopods", "Millipedes", "Spiders", 
                 "Predatory insects", "Pest insects", "Coleoptera", 
                 "Ants", "Soil macrofauna") ~ "Macrofauna",
    
    Actor %in% c("Acari", "Collembola", "Enchytraeids", 
                 "Herbivorous acari", "Soil mesofauna") ~ "Mesofauna",
    
    Actor %in% c("Bacterial feeders nematodes", "Fungal feeders nematodes", 
                 "Omnivore-predatory nematodes", "Omnivore nematodes", 
                "Plant feeders nematodes", 
                 "Predatory nematodes", "Protozoa", "Nematodes", "Growth promoting protozoa",  
                 "Soil microfauna") ~ "Microfauna",
    
    Actor %in% c("Soil fauna") ~ "Mixed/General",  
    TRUE ~ NA_character_
  ))

data <- data %>%
  mutate(study_type = na_if(trimws(study_type), ""))

data <- data %>%
  mutate(
    Effect = if_else(
      is.na(Effect), NA_character_,
      str_replace(str_trim(Effect), "^([[:alpha:]])", ~ str_to_upper(.x))
    )
  )

```

## Diagnostic plots
```{r}
data_counts <- data %>%
  pivot_longer(
    cols = c(Group, Practice, Property, Contrast, study_type, location_country, Actor),
    names_to = "category",
    values_to = "level"
  ) %>%
  group_by(category, level) %>%
  summarise(
    pattern_count = n(),
    DOIs_count    = n_distinct(DOI),
    .groups = "drop"
  )

print(data_counts)

```

```{r}
# Reorder category factor for facet_wrap
data_counts <- data_counts %>%
  filter(category != "Contrast") %>%
  mutate(category = factor(category, levels = c(
    "Group",   # replace with actual first category
    "Property",
    "Practice",
    "study_type",
    "location_country",
    "Actor"
  )))

# Updated plot
category_distribution <-
  ggplot(data_counts, aes(x = level, y = pattern_count, fill = category)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ category, scales = "free_y", ncol = 2) +
  coord_flip() +
  theme_bw() +
  theme(
    axis.text.y = element_text(hjust = 1),
    legend.position = "none",
    panel.grid.major = element_blank(),  # remove major grid lines
    panel.grid.minor = element_blank()   # remove minor grid lines
  ) +
  scale_fill_manual(values = c(
    "Group"       = "#D9A066",  # new earthy color
    "Property"         = "#C97C41",  # terracotta
    "Practice"         = "#8B5E3C",  # medium brown
    "study_type"       = "#5C4033",  # dark brown
    "location_country" = "#3E2723",  # very dark earthy brown
    "Actor"            = "#E3B448"   # ochre yellow
  )) +
  labs(x = NULL)


category_distribution

# Save
ggsave(filename = file.path(folder_path_plots, "category_distribution-patterns.png"),
       plot = category_distribution,
       width = 8, height =6, bg= "white")
```

```{r}
# Patterns per abstract (assuming each row = one pattern)
patterns_by_DOI <- data %>%
  filter(!is.na(DOI)) %>%
  count(DOI, name = "n_patterns")

overall_summary <- patterns_by_DOI %>%
  summarise(
    abstracts   = n(),
    total_patterns = sum(n_patterns),
    mean_patterns_per_abstract   = mean(n_patterns),
    median_patterns_per_abstract = median(n_patterns),
    p25 = quantile(n_patterns, 0.25),
    p75 = quantile(n_patterns, 0.75),
    min = min(n_patterns),
    max = max(n_patterns)
  )

patterns_by_DOI %>% arrange(desc(n_patterns)) %>% head(10)  # top contributors (optional)
overall_summary

```
```{r}
ggplot(patterns_by_DOI, aes(x = n_patterns)) +
  geom_histogram(binwidth = 1) +
  labs(x = "Patterns per abstract (DOI)", y = "Number of abstracts")

```
```{r}
by_cat_level <- data %>%
  filter(!is.na(DOI)) %>%
  pivot_longer(
    cols = c(Group, Practice, Property, Contrast, study_type, location_country, Actor),
    names_to = "category",
    values_to = "level"
  ) %>%
  group_by(category, level) %>%
  summarise(
    patterns   = n(),
    abstracts  = n_distinct(DOI),
    patterns_per_abstract = patterns / abstracts,
    .groups = "drop"
  ) %>%
  arrange(category, desc(abstracts), desc(patterns))

by_cat_level

write.csv(
  by_cat_level,
  file = file.path(folder_path_tables, "key_elements_distribution.csv"),
  row.names = FALSE
)


```

## Post-processing plot
Here we import one of the outputs of the "Filter_LLMs_output_v3.15", and is automatically saved in the folder "logs" under the name "output_final5_summary.csv" when ruuning the script.

```{r}
data_script <- readr::read_csv(
  "Filter_LLM_output_final_summary.csv",
  col_types = readr::cols(
    Step        = readr::col_character(),
    Description = readr::col_character(),
    Kept        = readr::col_integer(),  # use col_double() if not integer counts
    Removed     = readr::col_integer()
  ),
  show_col_types = FALSE
)
# Reshape to long format
data_script_long <- data_script %>%
  pivot_longer(cols = c(Kept, Removed),
               names_to = "Status",
               values_to = "Count")%>%
  dplyr::mutate(Status = factor(Status, levels = c("Removed", "Kept"))) 

# Plot stacked bar chart with earthy colors
harmonization_summary_plot <- ggplot(data_script_long, aes(x = Step, y = Count, fill = Status)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c(
    "Kept" = "black",    # earthy green
    "Removed" = "lightgrey"  # earthy reddish-brown
  )) +
  theme_bw() +
  labs(x = NULL, y = "Patterns", fill = NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_blank(),  # remove major grid lines
    panel.grid.minor = element_blank() )  # remove minor grid lines
harmonization_summary_plot

# Save
ggsave(filename = file.path(folder_path_plots, "harmonization_summary_plot.png"),
       plot = harmonization_summary_plot,
       width = 5, height =2.5, bg= "white")
```
## GAP plots
```{r}
data$driver_contrast_pairs <- with(data, interaction(Practice, Contrast, drop = TRUE))
levels(data$driver_contrast_pairs)
data$observation <- 1

#Unifiy contrasts
data <- data %>%
  dplyr::mutate(
    Contrast = ifelse(
      Practice == "Biochar" & driver_contrast_pairs %in% c("Biochar.Control", "Biochar.Unfertilized"),
      "No biochar",
      as.character(Contrast)  # keep other values unchanged
    ),
    Contrast = droplevels(factor(Contrast))  # convert to factor and drop unused levels
  )

data <- data %>%
  dplyr::mutate(
    Contrast = ifelse(
      Practice == "Retaining crop residues" & driver_contrast_pairs %in% c("Retaining crop residues.Control", "Retaining crop residues.Unfertilized"),
      "No retaining crop residues",
      as.character(Contrast)  # keep other values unchanged
    ),
    Contrast = droplevels(factor(Contrast))  # convert to factor and drop unused levels
  )

levels(data$Contrast)
```

Harmonize nematodes
```{r}
data
```

Adding Response_group terminology

```{r}
unique(levels(data$Actor))

data <- data %>%
  mutate(Group = case_when(
    Actor %in% c("Earthworms", "Isopods", "Millipedes", "Spiders", 
                 "Predatory insects", "Pest insects", "Coleoptera", 
                 "Ants", "Soil macrofauna") ~ "Macrofauna",
    
    Actor %in% c("Acari", "Collembola", "Enchytraeids", 
                 "Herbivorous acari", "Soil mesofauna") ~ "Mesofauna",
    
    Actor %in% c("Bacterial feeders nematodes", "Fungal feeders nematodes", 
                 "Omnivore-predatory nematodes", "Omnivore nematodes", 
                  "Plant feeders nematodes", 
                 "Predatory nematodes", "Protozoa", "Nematodes",   "Growth promoting protozoa", 
                 "Soil microfauna") ~ "Microfauna",
    
    Actor %in% c("Soil fauna") ~ "Mixed/General",
    
    TRUE ~ NA_character_
  ))
```

### Actor x Property
```{r}
data <- data %>%
    dplyr::mutate(
    AxP = interaction(Actor, Property, sep = "_"),
    DxC = interaction(Practice, Contrast, sep = "::"),
    AxPxDxC = interaction(Practice, Contrast, Actor, Property, sep = "::")
  )
```

```{r}
#Summaris counts per Effect and bar
data_aggregated <- data %>%
  dplyr::group_by(AxPxDxC, AxP, DxC, Effect, Group, Property) %>%
    dplyr::summarise(observation = sum(as.numeric(observation), na.rm = TRUE), .groups = "drop")

#Get totals per bar (across all effects)
data_totals <- data_aggregated %>%
    dplyr::group_by(AxPxDxC) %>%
  dplyr::summarise(Total_observations = sum(observation), .groups = "drop")

#Merge and calculate percentage
data_merged_final <- data_aggregated %>%
  left_join(data_totals, by = "AxPxDxC") %>%
  dplyr::mutate(Percentage = observation / Total_observations * 100)
```

```{r}
data_merged_final$Group <- factor(data_merged_final$Group,                   
                                                  levels = c("Macrofauna","Mesofauna","Microfauna","Microbiome", "Mixed/General"), 
                                                  labels = c("Macrofauna","Mesofauna","Microfauna","Microbiome", "Mix"))
```


```{r}
data_merged_final$DxC <- droplevels(data_merged_final$DxC)
levels(data_merged_final$DxC)

data_merged_final$DxC <- factor(data_merged_final$DxC,                   
                                                  levels = c("Biochar::No biochar","Retaining crop residues::No retaining crop residues"), 
                                                  labels = c("Biochar","Crop residues"))

data_merged_final$Property <- factor(data_merged_final$Property,                   
                                                  levels = c("abundance","activity","diversity", "ecological index"), 
                                                  labels = c("abu.","act.","div.", "EI"))



data_merged_final <- data_merged_final %>%
  mutate(
    AxP_short = factor(sub("_.*", "", AxP))
  )

levels(data_merged_final$AxP_short)


all_levels <- c(
  "Soil fauna",                     # overarching
  "Soil macrofauna",                # large soil animals
  "Earthworms",                     # macrofauna
  "Isopods",                        # macrofauna
  "Ants",                           # macrofauna
  "Coleoptera",                     # macrofauna/mesofauna
  "Soil mesofauna",                 # medium soil animals
  "Collembola",                      # mesofauna
  "Acari",                           # mesofauna
  "Soil microfauna",                 # small soil animals
  "Protozoa",                        # microfauna
   "Enchytraeids"  ,                   # micro/mesofauna
  "Nematodes",                       # microfauna
  "Bacterial feeders nematodes",     # microfauna functional
  "Fungal feeders nematodes",        # microfauna functional
  "Omnivore nematodes",              # microfauna functional
  "Omnivore-predatory nematodes",    # microfauna functional
  "Plant feeders nematodes",         # microfauna functional
  "Predatory nematodes"            # microfauna functional
       # microfauna functional
 
) 


data_merged_final$AxP_short <- factor(data_merged_final$AxP_short, levels = rev(all_levels))



```

```{r}
#Plot
plot_GAP1 <- ggplot(data_merged_final, aes(x = AxP_short, y = Percentage, fill = Effect, alpha = Total_observations)) +
  geom_bar(stat = "identity", width = 0.8) +
  labs(x = "", y = "Relative Abundance (%)", fill = "Effect") +
  geom_text(aes(label = observation),
            position = position_stack(vjust = 0.5),
            color = "black", size = 2.5,
            alpha = 1) +   # keep text labels fully opaque
  coord_flip() +
  facet_nested(Group + Property ~ DxC, scales = "free_y", space = "free", nest_line = TRUE) +
  guides(
    fill = guide_legend(nrow = 1, byrow = TRUE),
    alpha = "none"   # remove alpha legend
  ) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    strip.text = element_text(face = "bold", size = 8),
    strip.text.x = element_text(size = 8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    ggh4x.facet.nestline = element_line(linetype = 3)
  ) +
  scale_fill_manual(values = c("#E64B35B2", "#83A485", "#bfb1a4")) +
  scale_y_continuous(breaks = c(25, 75)) +
  scale_alpha_continuous(range = c(0.4, 1)) +  # control alpha scaling
  labs(x = "", y = "%", fill = "")
  

plot_GAP1
ggsave(filename = file.path(folder_path_plots, "GAP1_property.png"),
       plot = plot_GAP1,
       width = 6, height = 8.5, bg= "white")
```

### Actor 
```{r}
data_actor <- data %>%
  mutate(
    DxC = interaction(Practice, Contrast, sep = "::"),
    AxDxC = interaction(Practice, Contrast, Actor, sep = "::") # no property here
  )

data_actor_agg <- data_actor %>%
  dplyr::group_by(AxDxC, Actor, DxC, Effect, Group) %>%
  dplyr::summarise(observation = sum(as.numeric(observation), na.rm = TRUE),
                   .groups = "drop")

data_actor_totals <- data_actor_agg %>%
  dplyr::group_by(AxDxC) %>%
  dplyr::summarise(Total_observations = sum(observation), .groups = "drop")

data_actor_final <- data_actor_agg %>%
  left_join(data_actor_totals, by = "AxDxC") %>%
  mutate(Percentage = observation / Total_observations * 100)

data_actor_final$Group <- factor(data_actor_final$Group,                   
                               levels = c("Macrofauna","Mesofauna","Microfauna","Microbiome", "Mixed/General"), 
                               labels = c("Macrofauna","Mesof.","Microfauna","Microbiome", "Mix"))


data_actor_final$DxC <- droplevels(data_actor_final$DxC)
levels(data_merged_final$DxC)

data_actor_final$DxC <- factor(data_actor_final$DxC,                   
                             levels = c("Biochar::No biochar","Retaining crop residues::No retaining crop residues"), 
                             labels = c("Biochar","Crop residues"))


levels(data_actor_final$Actor)
data_actor_final$Actor <- factor(data_actor_final$Actor, 
                                   levels = rev(c(
                                     "Soil fauna",                     # overarching
  "Soil macrofauna",                # large soil animals
  "Earthworms",                     # macrofauna
  "Isopods",                        # macrofauna
  "Ants",                           # macrofauna
  "Coleoptera",                     # macrofauna/mesofauna
  "Soil mesofauna",                 # medium soil animals
  "Collembola",                      # mesofauna
  "Acari",                           # mesofauna
  "Soil microfauna",                 # small soil animals
  "Protozoa",                        # microfauna
   "Enchytraeids"  ,                   # micro/mesofauna
  "Nematodes",                       # microfauna
  "Bacterial feeders nematodes",     # microfauna functional
  "Fungal feeders nematodes",        # microfauna functional
  "Omnivore nematodes",              # microfauna functional
  "Omnivore-predatory nematodes",    # microfauna functional
  "Plant feeders nematodes",         # microfauna functional
  "Predatory nematodes"             # microfauna functional
 
 
                                   )))
```

```{r}
# Plot
plot_actor <- ggplot(data_actor_final, aes(x = Actor, y = Percentage, fill = Effect, alpha = Total_observations)) +
  geom_bar(stat = "identity", width = 0.8) +
  labs(x = "", y = "Relative Abundance (%)", fill = "Effect") +
  geom_text(aes(label = observation),
            position = position_stack(vjust = 0.5),
            color = "black", size = 2.5,
            alpha = 1) +   # keep text fully opaque
  coord_flip() +
  facet_nested(Group ~ DxC, scales = "free_y", space = "free", nest_line = TRUE) +
  guides(
    fill = guide_legend(nrow = 1, byrow = TRUE),
    alpha = "none"   # <-- remove alpha legend
  ) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    strip.text = element_text(face = "bold", size = 8),
    strip.text.x = element_text(size = 8),
    ggh4x.facet.nestline = element_line(linetype = 3),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  scale_fill_manual(values = c("#E64B35B2", "#83A485", "#bfb1a4")) +
  scale_y_continuous(breaks = c(25, 75)) +
  scale_alpha_continuous(range = c(0.4, 1))


plot_actor

# Save
ggsave(filename = file.path(folder_path_plots, "GAP1_actor_alpha.png"),
       plot = plot_actor,
       width = 6, height = 5, bg= "white")
```




